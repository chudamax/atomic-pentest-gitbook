## Check for Accounts In Privileged Groups [t-ad-privileged_groups-privileged_groups_enumeration]

Membership to the groups "Schema Admins" and "Enterprise Admins" are not required for everyday use,
as they are only required to make changes to the domain or forest in very rare cases.

Domain Admins, Backup Operators, DNS Admins groups are also very high privileged. Each of these 
accounts may have the ability to completely compromise the domain.

Check for Accounts In Privileged Groups: Domain Admins, Enterprise Admins, Schema Admins, 
DnsAdmins, Backup Operators.

Ensure security measures for privileged accounts are in place.

Privileged accounts should be reserved for administrative tasks, while non-privileged accounts should be used 
for regular activities, like logging into workstations and checking email.

Additionally, privileged accounts should be included in the AD "Protected Users" group. 
The Protected Users group offers extra protections to accounts, such as preventing authentication using NTLM,
restricting  delegation, blocking DES and RC4 encryption, etc.


### 9.1.1 Enumerate users in privileged AD groups.




**option 1: powershell_ad_module**

{% code overflow="wrap" %}
```bash
Get-ADGroupMember -Identity "Domain Admins" -Recursive
Get-ADGroupMember -Identity "Enterprise Admins" -Recursive
Get-ADGroupMember -Identity "Schema Admins" -Recursive
Get-ADGroupMember -Identity "DnsAdmins" -Recursive
Get-ADGroupMember -Identity "Backup Operators" -Recursive

```
{% endcode %}

{% hint style="info" %}You can add "| Measure-Object" to the powershell command to get a total number of the accounts

{% endhint %}


**option 2: bloodhound**

{% code overflow="wrap" %}
```bash
MATCH (u:User)-[:MemberOf]->(g:Group {name:'ENTERPRISE ADMINS@DOMAIN.COM'}) return u.name, u.displayname
MATCH (u:User)-[:MemberOf]->(g:Group {name:'SCHEMA ADMINS@DOMAIN.COM'}) return u.name, u.displayname
MATCH (u:User)-[:MemberOf]->(g:Group {name:'DOMAIN ADMINS@DOMAIN.COM'}) return u.name, u.displayname
MATCH (u:User)-[:MemberOf]->(g:Group {name:'DNSADMINS@DOMAIN.COM'}) return u.name, u.displayname
MATCH (u:User)-[:MemberOf]->(g:Group {name:'BACKUP OPERATORS@DOMAIN.COM'}) return u.name, u.displayname

```
{% endcode %}

{% hint style="info" %}domain groups and the domain name should be in uppercase

{% endhint %}


**option 3: ldapsearch**

{% code overflow="wrap" %}
```bash
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=Enterprise Admins,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=Schema Admins,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=Domain Admins,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=DNSAdmins,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=Backup Operators,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName

```
{% endcode %}

### 9.1.2 Check if privileged accounts are member of the "Protected Users" AD group.




**option 1: powershell_ad_module**

{% code overflow="wrap" %}
```bash
Get-ADGroupMember -Identity "Protected Users" -Recursive
```
{% endcode %}

{% hint style="info" %}If the "Protected Users" group is empty - it should be reported.

{% endhint %}


**option 2: bloodhound**

{% code overflow="wrap" %}
```bash
MATCH (u:User)-[:MemberOf]->(g:Group {name:'PROTECTED USERS@DOMAIN.COM'}) return u.name, u.displayname
```
{% endcode %}


**option 3: ldapsearch**

{% code overflow="wrap" %}
```bash
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=Protected Users,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName
```
{% endcode %}

### 9.1.3 Check if the administrators have separated accounts for administrative and usual tasks



{% code overflow="wrap" %}
```bash
For example, if John Smith has a normal user account of "jsmith" and there is a corresponding 
acount in the "Domain Admins" group called "_jsmith" or "jsmithADM", then they are likely 
separate accounts for the same user. If not, or there is no obvious separation of privileged 
from non-privileged accounts, then there is a risk that some users are using a privileged account 
for everyday activities such as checking emails or browsing the internet.

```
{% endcode %}

## Local Administrator Accounts [t-ad-privileged_groups-local_administrators]

Check if user accounts have admin privileges on any hosts


{% hint style="info" %}If the user has admin privileges - it makes sense to extract the local users NTLM hashes from the SAM database and try them to get access to other hosts.
{% endhint %}
### 9.1.1 Check using bloodhound



{% code overflow="wrap" %}
```bash
check the GUI and embedded bloodhound requests
```
{% endcode %}

### 9.1.2 Additionally check using SMB



{% code overflow="wrap" %}
```bash
crackmapexec smb ad_hosts.txt -u user -d domain -p password --continue-on-success
```
{% endcode %}

## Check for Accounts with RDP privileges [t-ad-privileged_groups-groups-rdp_privileges]

Check if user accounts have RDP privileges on any hosts


{% hint style="info" %}Both options should be checked
{% endhint %}
### 9.1.1 Check using bloodhound



{% code overflow="wrap" %}
```bash
check the GUI and embedded bloodhound requests
```
{% endcode %}

### 9.1.2 Additionally check for RDP access using patator



{% code overflow="wrap" %}
```bash
patator rdp_login host=FILE0 user=<domain/smpwduser> password='<P@ssw0rd>' 0=ad_hosts.txt -x ignore:mesg=ERRCONNECT_CONNECT_TRANSPORT_FAILED
```
{% endcode %}

{% hint style="info" %}ERRCONNECT_CONNECT_CANCELLED error code means that the password is ok and the user has RDP privileges, but there is a messag prompt that the current user will be disconnected

{% endhint %}

