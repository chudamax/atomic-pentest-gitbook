## SMB Null Session Enumeration [t-ad-smb-smb_null_session]

When an SMB session is established anonymously or with a guest account, it is commonly referred to as an SMB null session. 
This can be used to anonymously access SMB shares or call RPC operations using the IPC$ share and named pipes.

In general, the session establishment steps are as follows:
  - Connect to the IPC$ share
  - Open a named pipe (e.g., \pipe\samr to access the SAM RPC server)
  - Bind to a DCE-RPC interface (identified by a UUID; authentication is already done at the SMB level)
  - Call RPC operations.

Interesting named pipes for NULL sessions:
  \pipe\samr: SAM (Security Account Manager) RPC server
  \pipe\lsarpc: LSA (Local Security Authority) RPC server
  \pipe\netlogon: Netlogon RPC server
  \pipe\svcctl: SCM (Service Control Manager) RPC server
  \pipe\eventlog: Eventlog service RPC server
  \pipe\srvsvc: Server service RPC server
  \pipe\wkssvc: Workstation service RPC server


### 1.1.1 Enumerate SMB Shares accessible for the null session (empty user and password)




**option 1: crackmapexec**

{% code overflow="wrap" %}
```bash
#empty user
crackmapexec smb <hosts_file or network/mask> -u '' -p '' --shares

#guest account
crackmapexec smb <hosts_file> -u 'guest' -p '' --shares

#access the SMB shares
smbclient -N //host.domain.com/Public

```
{% endcode %}


**option 2: smbmap**

{% code overflow="wrap" %}
```bash
#empty user
python3 smbmap.py -r --host-file hosts.txt -u '' -p '' --csv null_session_shares --no-write-check --exclude ADMIN$ C$ IPC$

#guest account
python3 smbmap.py -r --host-file hosts.txt -u 'guest' -p '' --csv guest_shares_$name --no-write-check --exclude ADMIN$ C$ IPC$

#access the SMB shares
smbclient -N //host.domain.com/Public

```
{% endcode %}


**option 3: smbclient**

{% code overflow="wrap" %}
```bash
#empty user
smbclient -N -L //host.com

#guest account

#access the SMB shares
smbclient -N //host.domain.com/Public

```
{% endcode %}

### 1.1.2 Enumerate host using RPC calls



{% code overflow="wrap" %}
```bash
#Use rpcclient help to see options to request more data
rpcclient -c querydispinfo -U''%'' dc.domain.local
```
{% endcode %}

## SMB Shares Discovery [t-ad-smb-smb_shares]

Sometimes companies do not restrict shares that contain sensitive data to only readable by 
certain groups, and are open to all authenticated users or even without providing credentials (null/guest sessions). 
Such resources can contain sensitive data, backups, passwords, configuration files, etc.


### 1.1.1 Enumerate publicly accessible SMB shares




**option 1: crackmapexec**

{% code overflow="wrap" %}
```bash
crackmapexec smb <hosts_file> -u user -p 'P@ssw0rd' --shares
cmedb
cmedb (test)(smb) > export shares detailed shares.csv

```
{% endcode %}


**option 2: powerview**

{% code overflow="wrap" %}
```bash
Find-DomainShare -CheckShareAccess
```
{% endcode %}


**option 3: smbmap**

{% code overflow="wrap" %}
```bash
python3 smbmap.py -r --host-file $name -u user -d domain -p P@ssw0rd --csv authenticated_shares_$name --no-write-check --exclude ADMIN$ C$ IPC$
```
{% endcode %}

{% hint style="info" %}Supports Pass-the-Hash

{% endhint %}


**option 4: smbclient**

{% code overflow="wrap" %}
```bash
smbclient -L -U domain.com\\username //host.com
```
{% endcode %}

### 1.1.2 Access the SMB shares



{% code overflow="wrap" %}
```bash
smbclient -U domain.com\\username //domain.com/sharename

#kerberos
impacket-smbclient -k domain/username:'P@ssw0rd'@dc.domain.com

```
{% endcode %}

## SMB Signing check [t-ad-smb-smb_signing]

###  Check if SMB signing is requred



{% code overflow="wrap" %}
```bash
crackmapexec smb 445_hosts.txt
```
{% endcode %}

## SMBv1 check [t-ad-smb-smbv1]

###  Check if SMB v1 is enabled



{% code overflow="wrap" %}
```bash
crackmapexec smb 445_hosts.txt
```
{% endcode %}

